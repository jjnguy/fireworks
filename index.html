<!DOCTYPE html>
<html>

<head>

</head>

<body>
  <canvas id="sky"></canvas>
  <script>
    function random(min, max) {
      return Math.random() * (max - min) + min;
    }

    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random
    function randomInt(min, max) {
      min = Math.ceil(min);
      max = Math.floor(max);
      return Math.floor(Math.random() * (max - min) + min); //The maximum is exclusive and the minimum is inclusive
    }

    let canvas = document.getElementById("sky");
    canvas.width = 1000
    canvas.height = 600
    let ctx = canvas.getContext("2d");

    function randmomFirework() {
      return newFirework({ x: canvas.width / 2, y: canvas.height }, { x: random(-0.4, 0.4), y: random(-2, -0.5) });
    }

    function newFirework(origin, initialVelocity) {
      return {
        origin,
        velocity: initialVelocity,
        trail: {
          velocity: { x: 0, y: 0 },
          particles: [
            {
              position: origin,
              velocity: { x: 0, y: 0 },
              elapsed: 0,
              min: 0,
              max: 100
            }
          ]
        },
        explosion: null,
      }
    }

    let fireworks = []

    // https://www.sitepoint.com/quick-tip-game-loop-in-javascript/
    function update(progress) {

      fireworks.forEach(firework => {
        if (!firework.explosion) {
          let lastParticle = firework.trail.particles[firework.trail.particles.length - 1];
          firework.trail.particles.push({
            position: {
              x: lastParticle.position.x + progress * firework.velocity.x,
              y: lastParticle.position.y + progress * firework.velocity.y
            }
          });
          firework.velocity.x *= 0.95;
          firework.velocity.y *= 0.95;

          if (firework.velocity.y >= -0.02) {
            let raysCount = randomInt(5, 16);
            let rays = []
            let overallVelocity = random(0.15, 0.8);
            let increment = Math.PI * 2 / raysCount;
            let currentAngle = random(0, increment);
            for (let i = 0; i < raysCount; i++) {
              let x = Math.cos(currentAngle) * overallVelocity;
              let y = Math.sin(currentAngle) * overallVelocity;
              currentAngle += increment;
              rays.push({
                velocity: { x, y },
                particles: [
                  {
                    position: lastParticle.position,
                  }
                ]
              });
            }
            firework.explosion = {
              rays,
              elapsed: 0,
              min: 0,
              max: 100
            };
          }
        } else {
          firework.explosion.rays.forEach(ray => {
            let lastParticle = ray.particles[ray.particles.length - 1];
            ray.particles.push({
              position: {
                x: lastParticle.position.x + progress * ray.velocity.x,
                y: lastParticle.position.y + progress * ray.velocity.y
              },
            });
            ray.velocity.x *= 0.95;
            ray.velocity.y *= 0.95;

            if (Math.abs(ray.velocity.y) < 0.001 && Math.abs(ray.velocity.x) < 0.001) {
              firework.remove = true;
            }
          });
        }
      });

      fireworks = fireworks.filter(it => !it.remove);
      if (random(0, 1) < 0.05) {
        fireworks.push(randmomFirework())
      }
    }

    function draw() {
      ctx.strokeStyle = 'black';
      ctx.fillStyle = 'black';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      fireworks.forEach(firework => {
        if (firework.explosion) {
          let lastParticle = firework.trail.particles[firework.trail.particles.length - 1];

          firework.explosion.rays.forEach(ray => {
            let particleCount = ray.particles.length;
            ray.particles.forEach((particle, ix) => {
              ctx.fillStyle = `rgba(255, 0, 0, ${ix / particleCount})`
              ctx.fillRect(particle.position.x, particle.position.y, 3, 3);
            });
          });
        } else {
          let particleCount = firework.trail.particles.length;
          firework.trail.particles.forEach((particle, ix) => {
            ctx.fillStyle = `rgba(255, 255, 255, ${ix / particleCount})`
            ctx.fillRect(particle.position.x, particle.position.y, 2, 2)
          })
        }
      });
    }

    function loop(timestamp) {
      var progress = timestamp - lastRender

      update(progress)
      draw()

      lastRender = timestamp
      window.requestAnimationFrame(loop)
    }
    var lastRender = 0
    window.requestAnimationFrame(loop)
  </script>
</body>

</html>