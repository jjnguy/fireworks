<!DOCTYPE html>
<html>

<head>

</head>

<body>
  <canvas id="sky"></canvas>
  <script>
    function random(min, max) {
      return Math.random() * (max - min) + min;
    }

    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random
    function randomInt(min, max) {
      min = Math.ceil(min);
      max = Math.floor(max);
      return Math.floor(Math.random() * (max - min) + min); //The maximum is exclusive and the minimum is inclusive
    }

    let canvas = document.getElementById("sky");
    canvas.width = 1000
    canvas.height = 600
    let ctx = canvas.getContext("2d");

    function randmomFirework() {
      return newFirework({ x: canvas.width / 2, y: canvas.height }, { x: random(-0.4, 0.4), y: random(-2, -0.5) });
    }

    function newFirework(origin, initialVelocity) {
      return {
        origin,
        velocity: initialVelocity,
        trail: {
          velocity: { x: 0, y: 0 },
          particles: [
            {
              position: origin,
              velocity: { x: 0, y: 0 },
              elapsed: 0,
              min: 0,
              max: 100
            }
          ]
        },
        explosion: null,
      }
    }

    let fireworks = []

    // https://www.sitepoint.com/quick-tip-game-loop-in-javascript/
    function update(progress) {

      fireworks.forEach(firework => {
        if (firework.velocity.y < -0.02) {
          let lastParticle = firework.trail.particles[firework.trail.particles.length - 1];
          firework.trail.particles.push({
            position: {
              x: lastParticle.position.x + progress * firework.velocity.x,
              y: lastParticle.position.y + progress * firework.velocity.y
            }
          });
          firework.velocity.x *= 0.95;
          firework.velocity.y *= 0.95;
        } else {
          let raysCount = randomInt(5, 8);
          let rays =
            firework.explosion = {
              rays: [
                {
                  velocity: { x: 0, y: 0 },
                  particles: [
                    {
                      position: { x: 0, y: 0 },
                      velocity: { x: 0, y: 0 },
                      elapsed: 0,
                      min: 0,
                      max: 100
                    }
                  ]
                }
              ],
              elapsed: 0,
              min: 0,
              max: 100
            };
          //firework.remove = true;
        }
      });
      fireworks = fireworks.filter(it => !it.remove);
      if (random(0, 1) < 0.05) {
        fireworks.push(randmomFirework())
      }
    }

    function draw() {
      ctx.strokeStyle = 'black';
      ctx.fillStyle = 'black';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      fireworks.forEach(firework => {
        if (firework.explosion) {
          let lastParticle = firework.trail.particles[firework.trail.particles.length - 1];

          ctx.fillStyle = 'red';
          ctx.fillRect(lastParticle.position.x, lastParticle.position.y, 30, 30);
        } else {
          firework.trail.particles.forEach(particle => {
            ctx.fillStyle = 'white'
            ctx.fillRect(particle.position.x, particle.position.y, 2, 2)
          })
        }
      });
    }

    function loop(timestamp) {
      var progress = timestamp - lastRender

      update(progress)
      draw()

      lastRender = timestamp
      window.requestAnimationFrame(loop)
    }
    var lastRender = 0
    window.requestAnimationFrame(loop)
  </script>
</body>

</html>